AWSTemplateFormatVersion: '2010-09-09'
Description: 'EC2 Instance'

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, prod]
  PrivateSubnetId:
    Type: String
  EC2SecurityGroupId:
    Type: String
  TargetGroupArn:
    Type: String

Resources:
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ELBRegistration
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticloadbalancing:RegisterTargets
                  - elasticloadbalancing:DeregisterTargets
                Resource: '*'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.micro
      SubnetId: !Ref PrivateSubnetId
      SecurityGroupIds:
        - !Ref EC2SecurityGroupId
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          ENVIRONMENT=${Environment}
          dnf update -y
          dnf install -y nginx
          systemctl enable nginx
          systemctl start nginx
          cat <<EOF > /usr/share/nginx/html/index.html
          <html>
          <head><title>${Environment} Server</title></head>
          <body>
          <h1>Hello from ${Environment} environment!</h1>
          <p>This page is served by Nginx on Amazon Linux 2023</p>
          </body>
          </html>
          EOF
          
          # Register with target group
          INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
          aws elbv2 register-targets --target-group-arn ${TargetGroupArn} --targets Id=$INSTANCE_ID,Port=80
      Tags:
        - Key: Name
          Value: !Sub 'web-ec2-${Environment}'



Outputs:
  EC2InstanceId:
    Value: !Ref EC2Instance